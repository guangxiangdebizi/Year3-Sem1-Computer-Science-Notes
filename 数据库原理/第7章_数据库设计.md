# 第7章 数据库设计

## 学习目标
- 理解数据库设计的基本概念和重要性
- 掌握数据库设计的六个阶段
- 熟练使用E-R模型进行概念结构设计
- 掌握E-R图向关系模型的转换方法
- 了解物理设计的基本原理
- 掌握数据库设计的实施和维护方法

```mermaid
mindmap
  root((数据库设计))
    设计阶段
      需求分析
      概念结构设计
      逻辑结构设计
      物理结构设计
      数据库实施
      数据库运行和维护
    设计方法
      新奥尔良方法
      基于E-R模型的方法
      3NF的设计方法
      面向对象的方法
    E-R模型
      实体
      属性
      联系
      E-R图
    转换规则
      实体转换
      联系转换
      属性转换
    物理设计
      存储结构
      存取方法
      索引设计
```

## 7.1 数据库设计概述

### 7.1.1 数据库设计的特点

```mermaid
graph TD
    A[数据库设计特点] --> B[结构设计与行为设计相结合]
    A --> C[需要考虑数据与处理的结合]
    A --> D[设计过程是一个反复的过程]
    
    B --> B1[数据结构设计<br/>确定数据库中存储什么数据]
    B --> B2[行为设计<br/>确定在数据库上执行什么处理]
    
    C --> C1[数据设计<br/>数据库结构设计]
    C --> C2[处理设计<br/>应用程序设计]
    
    D --> D1[各阶段设计结果需要反复修改]
    D --> D2[上一阶段设计结果是下一阶段设计的基础]
    
    style B fill:#e3f2fd
    style C fill:#e8f5e8
    style D fill:#fff3e0
```

### 7.1.2 数据库设计方法

```mermaid
graph LR
    A[数据库设计方法] --> B[新奥尔良方法<br/>New Orleans Method]
    A --> C[基于E-R模型的方法]
    A --> D[基于3NF的设计方法]
    A --> E[面向对象的设计方法]
    
    B --> B1[自顶向下<br/>逐步求精]
    C --> C1[概念设计<br/>逻辑设计分离]
    D --> D1[直接从需求分析<br/>到关系模式]
    E --> E1[面向对象<br/>建模方法]
    
    style C fill:#4caf50
```

## 7.2 数据库设计过程

### 7.2.1 数据库设计的六个阶段

```mermaid
flowchart TD
    A[需求分析阶段] --> B[概念结构设计阶段]
    B --> C[逻辑结构设计阶段]
    C --> D[物理结构设计阶段]
    D --> E[数据库实施阶段]
    E --> F[数据库运行和维护阶段]
    
    A --> A1[分析用户需求<br/>确定数据库边界]
    B --> B1[设计概念模型<br/>E-R图]
    C --> C1[转换为逻辑模型<br/>关系模式]
    D --> D1[设计物理存储结构<br/>存取方法]
    E --> E1[建立数据库<br/>装入数据]
    F --> F1[运行维护<br/>监控调优]
    
    style A fill:#ffcdd2
    style B fill:#e8f5e8
    style C fill:#bbdefb
    style D fill:#fff3e0
    style E fill:#f3e5f5
    style F fill:#e1f5fe
```

### 7.2.2 各阶段的设计描述

```mermaid
graph TD
    subgraph "设计阶段与描述工具"
        A[需求分析] --> A1[数据字典<br/>数据流图<br/>功能层次图]
        B[概念设计] --> B1[E-R图<br/>扩展E-R图]
        C[逻辑设计] --> C1[关系模式<br/>网状模式<br/>层次模式]
        D[物理设计] --> D1[存储记录格式<br/>存取方法<br/>索引]
    end
    
    style A1 fill:#ffcdd2
    style B1 fill:#e8f5e8
    style C1 fill:#bbdefb
    style D1 fill:#fff3e0
```

## 7.3 需求分析

### 7.3.1 需求分析的任务

```mermaid
graph TD
    A[需求分析任务] --> B[信息要求分析]
    A --> C[处理要求分析]
    A --> D[安全性与完整性要求]
    
    B --> B1[用户需要从数据库中获得什么信息]
    B --> B2[数据库需要存储哪些数据]
    
    C --> C1[用户要完成什么处理功能]
    C --> C2[处理的响应时间要求]
    C --> C3[处理方式是批处理还是联机处理]
    
    D --> D1[安全性要求]
    D --> D2[完整性要求]
    D --> D3[可靠性要求]
    
    style B fill:#e3f2fd
    style C fill:#e8f5e8
    style D fill:#fff3e0
```

### 7.3.2 需求分析的方法

```mermaid
flowchart LR
    A[需求分析方法] --> B[调研组织机构]
    A --> C[熟悉工作流程]
    A --> D[明确用户需求]
    A --> E[确定系统边界]
    
    B --> B1[了解组织结构<br/>职能部门]
    C --> C1[业务流程<br/>数据流程]
    D --> D1[功能需求<br/>性能需求]
    E --> E1[系统与外界接口<br/>系统内部边界]
```

### 7.3.3 数据字典

数据字典是关于数据库中数据的描述，即元数据，而不是数据本身。

```mermaid
graph TD
    A[数据字典内容] --> B[数据项]
    A --> C[数据结构]
    A --> D[数据流]
    A --> E[数据存储]
    A --> F[处理过程]
    
    B --> B1[数据项名<br/>数据项含义说明<br/>别名<br/>数据类型<br/>长度<br/>取值范围]
    
    C --> C1[数据结构名<br/>含义说明<br/>组成]
    
    D --> D1[数据流名<br/>说明<br/>数据流来源<br/>数据流去向<br/>组成<br/>平均流量<br/>高峰期流量]
    
    style B fill:#e3f2fd
    style C fill:#e8f5e8
    style D fill:#fff3e0
```

## 7.4 概念结构设计

### 7.4.1 概念结构设计的特点和策略

```mermaid
graph TD
    A[概念结构特点] --> B[能真实充分地反映现实世界]
    A --> C[易于理解]
    A --> D[易于更改]
    A --> E[易于向关系、网状、层次等各种数据模型转换]
    
    F[设计策略] --> G[自顶向下]
    F --> H[自底向上]
    F --> I[逐步扩张]
    F --> J[混合策略]
    
    G --> G1[首先定义全局概念结构的框架<br/>然后逐步细化]
    H --> H1[首先定义各局部概念结构<br/>然后将它们集成起来]
    I --> I1[首先定义最重要的核心概念结构<br/>然后向外扩充]
    J --> J1[将自顶向下和自底向上相结合<br/>用于大型数据库设计]
    
    style A fill:#e3f2fd
    style F fill:#e8f5e8
```

### 7.4.2 E-R模型

#### 实体-联系方法

```mermaid
erDiagram
    STUDENT {
        string Sno PK "学号"
        string Sname "姓名"
        string Ssex "性别"
        int Sage "年龄"
        string Sdept "系别"
    }
    
    COURSE {
        string Cno PK "课程号"
        string Cname "课程名"
        int Ccredit "学分"
    }
    
    TEACHER {
        string Tno PK "教师号"
        string Tname "教师名"
        string Title "职称"
    }
    
    STUDENT ||--o{ SC : "选修"
    COURSE ||--o{ SC : "被选修"
    TEACHER ||--o{ TEACH : "教授"
    COURSE ||--o{ TEACH : "被教授"
    
    SC {
        string Sno FK
        string Cno FK
        int Grade "成绩"
    }
    
    TEACH {
        string Tno FK
        string Cno FK
    }
```

#### E-R图的基本元素

```mermaid
graph TD
    A[E-R图基本元素] --> B[实体Entity]
    A --> C[属性Attribute]
    A --> D[联系Relationship]
    
    B --> B1[矩形框表示<br/>框内写实体名]
    C --> C1[椭圆形表示<br/>框内写属性名]
    D --> D1[菱形框表示<br/>框内写联系名]
    
    subgraph "属性类型"
        E[简单属性]
        F[复合属性]
        G[多值属性]
        H[派生属性]
        I[码属性]
    end
    
    E --> E1[不可再分的属性]
    F --> F1[可以再分的属性]
    G --> G1[具有多个值的属性]
    H --> H1[可以从其他属性计算得出]
    I --> I1[唯一标识实体的属性]
    
    style B1 fill:#ffcdd2
    style C1 fill:#e8f5e8
    style D1 fill:#bbdefb
```

#### 联系的类型

```mermaid
graph TD
    A[联系类型] --> B[一对一联系<br/>1:1]
    A --> C[一对多联系<br/>1:n]
    A --> D[多对多联系<br/>m:n]
    
    subgraph "1:1示例"
        E[系] --> F[系主任]
        E -.->|管理| F
    end
    
    subgraph "1:n示例"
        G[系] --> H[学生]
        G -.->|包含| H
    end
    
    subgraph "m:n示例"
        I[学生] --> J[课程]
        I -.->|选修| J
    end
    
    style B fill:#ffcdd2
    style C fill:#e8f5e8
    style D fill:#bbdefb
```

### 7.4.3 E-R图的集成

当采用自底向上的设计策略时，各分E-R图之间可能存在冲突，需要消除。

```mermaid
graph TD
    A[E-R图集成冲突] --> B[属性冲突]
    A --> C[命名冲突]
    A --> D[结构冲突]
    
    B --> B1[属性域冲突<br/>属性取值类型冲突]
    C --> C1[同名异义<br/>异名同义]
    D --> D1[同一对象在不同应用中<br/>具有不同的抽象]
    
    subgraph "冲突消解"
        E[统一命名]
        F[统一属性域]
        G[统一抽象层次]
    end
    
    style B fill:#ffcdd2
    style C fill:#e8f5e8
    style D fill:#bbdefb
```

## 7.5 逻辑结构设计

### 7.5.1 E-R图向关系模型的转换

#### 转换规则

```mermaid
flowchart TD
    A[E-R图转换规则] --> B[实体转换]
    A --> C[联系转换]
    
    B --> B1[一个实体转换为一个关系模式<br/>实体的属性就是关系的属性<br/>实体的码就是关系的码]
    
    C --> C1[1:1联系转换]
    C --> C2[1:n联系转换]
    C --> C3[m:n联系转换]
    
    C1 --> C11[可以与任意一端实体对应的关系模式合并<br/>也可以单独转换为一个关系模式]
    
    C2 --> C21[与n端实体对应的关系模式合并<br/>在n端关系中加入1端的码]
    
    C3 --> C31[单独转换为一个关系模式<br/>关系的码为各实体码的组合]
    
    style B1 fill:#e3f2fd
    style C11 fill:#e8f5e8
    style C21 fill:#fff3e0
    style C31 fill:#ffcdd2
```

#### 转换示例

```mermaid
erDiagram
    STUDENT {
        string Sno PK
        string Sname
        int Sage
    }
    
    COURSE {
        string Cno PK
        string Cname
        int Ccredit
    }
    
    STUDENT ||--o{ TAKES : "选修"
    COURSE ||--o{ TAKES : "被选修"
    
    TAKES {
        string Sno FK
        string Cno FK
        int Grade
    }
```

**转换结果：**
```sql
Student(Sno, Sname, Sage)
Course(Cno, Cname, Ccredit)
SC(Sno, Cno, Grade)
```

### 7.5.2 数据模型的优化

```mermaid
graph TD
    A[数据模型优化] --> B[确定数据依赖]
    A --> C[消除冗余的联系]
    A --> D[确定范式级别]
    A --> E[进行模式分解]
    
    B --> B1[根据语义确定函数依赖<br/>多值依赖等数据依赖]
    
    C --> C1[如果实体间既有直接联系<br/>又有间接联系，且直接联系<br/>能由间接联系导出，则去掉直接联系]
    
    D --> D1[分析各关系模式的范式级别<br/>是否符合应用要求]
    
    E --> E1[对于不符合要求的关系模式<br/>进行分解]
    
    style B fill:#e3f2fd
    style C fill:#e8f5e8
    style D fill:#fff3e0
    style E fill:#ffcdd2
```

### 7.5.3 设计用户子模式

```mermaid
graph TD
    A[用户子模式设计] --> B[使用更符合用户习惯的别名]
    A --> C[针对不同级别的用户定义不同的视图]
    A --> D[简化用户对系统的使用]
    
    B --> B1[Student可以定义别名为学生]
    C --> C1[学生用户只能看到自己的信息<br/>教师用户可以看到所教课程的信息<br/>管理员可以看到所有信息]
    D --> D1[通过视图隐藏复杂的连接操作]
    
    style B fill:#e3f2fd
    style C fill:#e8f5e8
    style D fill:#fff3e0
```

## 7.6 物理结构设计

### 7.6.1 物理设计的内容

```mermaid
graph TD
    A[物理设计内容] --> B[为关系模式选择存取方法]
    A --> C[设计关系、索引等数据库文件的物理存储结构]
    A --> D[对数据库设计进行评价]
    
    B --> B1[堆文件<br/>索引文件<br/>散列文件]
    C --> C1[确定数据的存放位置<br/>存储分配参数<br/>建立索引]
    D --> D1[时间效率<br/>空间效率<br/>维护代价]
    
    style B fill:#e3f2fd
    style C fill:#e8f5e8
    style D fill:#fff3e0
```

### 7.6.2 关系模式存取方法选择

```mermaid
flowchart TD
    A[选择存取方法] --> B{查询条件分析}
    
    B --> C[等值查询为主]
    B --> D[范围查询为主]
    B --> E[顺序访问为主]
    
    C --> F[散列存取方法<br/>Hash]
    D --> G[索引存取方法<br/>B+树索引]
    E --> H[顺序存取方法<br/>堆文件]
    
    subgraph "索引设计原则"
        I[经常查询的属性建立索引]
        J[经常更新的属性避免建立索引]
        K[取值重复率高的属性不建立索引]
    end
    
    style F fill:#ffcdd2
    style G fill:#e8f5e8
    style H fill:#bbdefb
```

### 7.6.3 数据库物理设计的评价

```mermaid
graph TD
    A[物理设计评价] --> B[时间效率]
    A --> C[空间效率]
    A --> D[维护代价]
    
    B --> B1[数据库运行时间<br/>包括CPU时间和等待时间]
    B --> B2[响应时间<br/>从用户发出请求到系统给出响应的时间间隔]
    
    C --> C1[数据库文件占用的存储空间]
    
    D --> D1[数据库投入运行后<br/>对数据库进行修改和调整的开销]
    
    subgraph "评价方法"
        E[定量估算各种方案的时空开销]
        F[做模拟试验比较各方案的优缺点]
        G[对关键应用进行详细分析]
    end
    
    style B fill:#e3f2fd
    style C fill:#e8f5e8
    style D fill:#fff3e0
```

## 7.7 数据库实施

### 7.7.1 数据库实施的内容

```mermaid
flowchart TD
    A[数据库实施] --> B[建立数据库结构]
    A --> C[装入数据]
    A --> D[编制与调试应用程序]
    A --> E[数据库试运行]
    
    B --> B1[用DDL定义数据库结构]
    C --> C1[组织数据入库<br/>数据转换]
    D --> D1[编制应用程序<br/>调试应用程序]
    E --> E1[功能测试<br/>性能测试]
    
    style B fill:#e3f2fd
    style C fill:#e8f5e8
    style D fill:#fff3e0
    style E fill:#ffcdd2
```

### 7.7.2 数据载入

```mermaid
graph TD
    A[数据载入方式] --> B[人工载入]
    A --> C[计算机载入]
    
    B --> B1[数据量小时使用<br/>通过应用程序界面输入]
    
    C --> C1[批量载入<br/>数据转换程序<br/>数据导入工具]
    
    subgraph "数据转换"
        D[数据格式转换]
        E[数据内容转换]
        F[数据检验]
    end
    
    D --> D1[不同系统间的数据格式差异]
    E --> E1[编码方式的转换]
    F --> F1[数据的完整性检验]
    
    style B fill:#e3f2fd
    style C fill:#e8f5e8
```

## 7.8 数据库运行和维护

### 7.8.1 数据库运行和维护的内容

```mermaid
graph TD
    A[数据库运行维护] --> B[数据库的转储和恢复]
    A --> C[数据库的安全性、完整性控制]
    A --> D[数据库性能的监督、分析和改进]
    A --> E[数据库的重组织和重构造]
    
    B --> B1[定期转储<br/>故障恢复]
    C --> C1[用户权限管理<br/>数据完整性约束]
    D --> D1[性能监控<br/>查询优化<br/>索引调整]
    E --> E1[数据重组织<br/>模式重构造]
    
    style B fill:#ffcdd2
    style C fill:#e8f5e8
    style D fill:#fff3e0
    style E fill:#bbdefb
```

### 7.8.2 数据库性能调优

```mermaid
flowchart TD
    A[性能调优] --> B[监控系统性能]
    B --> C{发现性能瓶颈?}
    C -->|是| D[分析瓶颈原因]
    C -->|否| E[继续监控]
    
    D --> F[调整策略]
    F --> G[索引优化]
    F --> H[查询优化]
    F --> I[存储优化]
    F --> J[系统参数调整]
    
    G --> K[添加/删除索引]
    H --> L[重写SQL语句]
    I --> M[调整存储结构]
    J --> N[调整缓冲区大小]
    
    K --> O[测试性能改进]
    L --> O
    M --> O
    N --> O
    
    O --> C
    
    style C fill:#fff3e0
    style O fill:#e8f5e8
```

## 7.9 学习检查点

### 7.9.1 重点概念总结

```mermaid
mindmap
  root((数据库设计))
    设计过程
      需求分析
        信息要求
        处理要求
        安全完整性要求
      概念设计
        E-R模型
        实体联系属性
      逻辑设计
        E-R图转换
        模式优化
      物理设计
        存取方法
        索引设计
    设计方法
      自顶向下
      自底向上
      逐步扩张
      混合策略
    实施维护
      数据库建立
      数据装入
      性能调优
      运行维护
```

### 7.9.2 练习题

1. **概念设计练习**
   - 根据给定需求绘制E-R图
   - 分析实体、属性和联系
   - 确定联系的类型

2. **逻辑设计练习**
   - E-R图向关系模式转换
   - 关系模式优化
   - 范式分析和模式分解

3. **物理设计练习**
   - 选择合适的存取方法
   - 设计索引策略
   - 评估设计方案

### 7.9.3 思考题

1. 数据库设计为什么要分阶段进行？各阶段的主要任务是什么？
2. E-R模型的优点是什么？为什么广泛用于概念设计？
3. 如何根据应用特点选择合适的存取方法？
4. 数据库设计中如何平衡性能和存储空间的关系？

## 7.10 设计实例

### 7.10.1 学生管理系统设计

```mermaid
erDiagram
    STUDENT {
        string Sno PK "学号"
        string Sname "姓名"
        string Ssex "性别"
        date Sbirth "出生日期"
        string Sdept "系别"
    }
    
    COURSE {
        string Cno PK "课程号"
        string Cname "课程名"
        string Cpno FK "先修课程"
        int Ccredit "学分"
    }
    
    TEACHER {
        string Tno PK "教师号"
        string Tname "教师名"
        string Tsex "性别"
        date Tbirth "出生日期"
        string Title "职称"
        string Tdept "系别"
    }
    
    DEPT {
        string Dno PK "系号"
        string Dname "系名"
        string Dean "系主任"
    }
    
    STUDENT ||--o{ SC : "选修"
    COURSE ||--o{ SC : "被选修"
    TEACHER ||--o{ TC : "教授"
    COURSE ||--o{ TC : "被教授"
    DEPT ||--o{ STUDENT : "包含学生"
    DEPT ||--o{ TEACHER : "包含教师"
    COURSE ||--o{ COURSE : "先修关系"
    
    SC {
        string Sno FK
        string Cno FK
        int Grade "成绩"
    }
    
    TC {
        string Tno FK
        string Cno FK
    }
```

---

**本章小结**：数据库设计是一个复杂的工程过程，需要遵循科学的设计方法和步骤。通过需求分析、概念设计、逻辑设计、物理设计等阶段，可以设计出满足用户需求、性能良好的数据库系统。E-R模型是概念设计的有力工具，掌握E-R图的绘制和转换是数据库设计的关键技能。