# 第9章 数据库恢复技术

## 学习目标
- 理解数据库恢复的基本概念和重要性
- 掌握事务的概念和ACID特性
- 了解各种故障类型及其影响
- 掌握数据库恢复的基本技术
- 理解日志文件的作用和管理
- 掌握检查点技术和恢复策略
- 了解备份与恢复的实施方案

```mermaid
mindmap
  root((数据库恢复技术))
    故障类型
      事务内部故障
      系统故障
      介质故障
      计算机病毒
    恢复技术
      数据转储
      登记日志文件
      检查点技术
      镜像技术
    恢复策略
      事务故障恢复
      系统故障恢复
      介质故障恢复
    日志管理
      日志记录
      日志缓冲区
      日志文件
      WAL协议
    备份策略
      静态转储
      动态转储
      海量转储
      增量转储
```

## 9.1 事务的基本概念

### 9.1.1 事务的定义

```mermaid
graph TD
    A[事务 Transaction] --> B[定义]
    A --> C[特点]
    A --> D[状态]
    
    B --> B1[用户定义的一个数据库操作序列<br/>这些操作要么全做，要么全不做<br/>是一个不可分割的工作单位]
    
    C --> C1[原子性 Atomicity]
    C --> C2[一致性 Consistency]
    C --> C3[隔离性 Isolation]
    C --> C4[持久性 Durability]
    
    D --> D1[活动状态 Active]
    D --> D2[部分提交状态 Partially Committed]
    D --> D3[提交状态 Committed]
    D --> D4[失败状态 Failed]
    D --> D5[中止状态 Aborted]
    
    style C fill:#e3f2fd
```

### 9.1.2 事务的ACID特性

```mermaid
graph TD
    A[ACID特性] --> B[原子性<br/>Atomicity]
    A --> C[一致性<br/>Consistency]
    A --> D[隔离性<br/>Isolation]
    A --> E[持久性<br/>Durability]
    
    B --> B1[事务是数据库的逻辑工作单位<br/>事务中包括的诸操作要么全做，要么全不做]
    
    C --> C1[事务执行的结果必须是使数据库<br/>从一个一致性状态变到另一个一致性状态]
    
    D --> D1[一个事务的执行不能被其他事务干扰<br/>即一个事务内部的操作及使用的数据<br/>对其他并发事务是隔离的]
    
    E --> E1[一个事务一旦提交，它对数据库中<br/>数据的改变就应该是永久性的<br/>接下来的其他操作或故障不应该<br/>对其执行结果有任何影响]
    
    style B fill:#ffcdd2
    style C fill:#e8f5e8
    style D fill:#bbdefb
    style E fill:#fff3e0
```

### 9.1.3 事务的状态转换

```mermaid
stateDiagram-v2
    [*] --> Active : 开始执行
    Active --> PartiallyCommitted : 最后一条语句执行完
    Active --> Failed : 发现事务无法正常执行
    PartiallyCommitted --> Committed : 提交成功
    PartiallyCommitted --> Failed : 提交失败
    Failed --> Aborted : 回滚完成
    Aborted --> [*] : 事务结束
    Committed --> [*] : 事务结束
    
    note right of Active : 事务正在执行
    note right of PartiallyCommitted : 等待提交
    note right of Committed : 事务成功完成
    note right of Failed : 事务执行失败
    note right of Aborted : 事务被撤销
```

## 9.2 数据库恢复概述

### 9.2.1 故障的种类

```mermaid
graph TD
    A[数据库故障类型] --> B[事务内部的故障]
    A --> C[系统故障]
    A --> D[介质故障]
    A --> E[计算机病毒]
    
    B --> B1[逻辑错误<br/>数据异常<br/>违反完整性约束]
    B --> B2[影响范围: 单个事务<br/>恢复方法: 事务撤销]
    
    C --> C1[硬件故障<br/>软件错误<br/>操作员失误<br/>突然停电]
    C --> C2[影响范围: 所有运行事务<br/>恢复方法: 系统重启恢复]
    
    D --> D1[磁盘损坏<br/>磁头碰撞<br/>瞬时强磁场干扰]
    D --> D2[影响范围: 数据库部分或全部<br/>恢复方法: 重装数据库]
    
    E --> E1[程序被破坏<br/>数据被破坏]
    E --> E2[影响范围: 不确定<br/>恢复方法: 发现及时可恢复]
    
    style B fill:#ffcdd2
    style C fill:#ff9800
    style D fill:#f44336
    style E fill:#9c27b0
```

### 9.2.2 恢复的实现技术

```mermaid
graph TD
    A[恢复实现技术] --> B[数据转储]
    A --> C[登记日志文件]
    A --> D[检查点技术]
    A --> E[镜像技术]
    
    B --> B1[定期将整个数据库复制到磁带<br/>或另一个磁盘上保存起来]
    B --> B2[静态转储 vs 动态转储<br/>海量转储 vs 增量转储]
    
    C --> C1[记录事务对数据库的更新操作<br/>以便故障恢复时重做或撤销]
    C --> C2[日志记录格式<br/>日志文件管理]
    
    D --> D1[在日志文件中设置检查点<br/>减少恢复时需要处理的日志量]
    D --> D2[检查点记录<br/>恢复时的处理]
    
    E --> E1[根据数据的重要性<br/>将关键数据在多个磁盘上<br/>保存多个副本]
    E --> E2[实时镜像<br/>异步镜像]
    
    style B fill:#e3f2fd
    style C fill:#e8f5e8
    style D fill:#fff3e0
    style E fill:#f3e5f5
```

## 9.3 日志文件

### 9.3.1 日志记录的内容

```mermaid
graph TD
    A[日志记录内容] --> B[事务标识]
    A --> C[操作类型]
    A --> D[操作对象]
    A --> E[更新前的值]
    A --> F[更新后的值]
    A --> G[时间戳]
    
    B --> B1[唯一标识事务的ID]
    C --> C1[INSERT, DELETE, UPDATE<br/>BEGIN, COMMIT, ABORT]
    D --> D1[被操作的数据项<br/>表名、记录标识等]
    E --> E1[Before Image<br/>用于撤销操作]
    F --> F1[After Image<br/>用于重做操作]
    G --> G1[操作发生的时间<br/>用于确定操作顺序]
    
    subgraph "日志记录示例"
        H[<T1, BEGIN>]
        I[<T1, X, 100, 200>]
        J[<T1, Y, 50, 80>]
        K[<T1, COMMIT>]
    end
    
    style E fill:#ffcdd2
    style F fill:#4caf50
```

### 9.3.2 日志文件的组织

```mermaid
graph TD
    A[日志文件组织] --> B[顺序文件]
    A --> C[日志缓冲区]
    A --> D[WAL协议]
    
    B --> B1[按时间顺序记录<br/>便于恢复时顺序处理]
    
    C --> C1[内存中的日志缓冲区<br/>提高日志写入效率<br/>定期刷新到磁盘]
    
    D --> D1[Write-Ahead Logging<br/>数据页写入磁盘前<br/>相应的日志记录必须先写入磁盘]
    
    subgraph "日志写入过程"
        E[事务操作] --> F[写入日志缓冲区]
        F --> G[刷新到日志文件]
        G --> H[更新数据页]
        H --> I[刷新数据页到磁盘]
    end
    
    style D fill:#4caf50
```

### 9.3.3 日志文件的管理

```mermaid
flowchart TD
    A[日志文件管理] --> B[日志文件切换]
    A --> C[日志文件归档]
    A --> D[日志文件清理]
    
    B --> B1[当前日志文件满时<br/>切换到新的日志文件]
    
    C --> C1[将旧的日志文件<br/>移动到归档存储<br/>用于长期保存]
    
    D --> D1[删除不再需要的<br/>日志文件<br/>释放存储空间]
    
    subgraph "日志生命周期"
        E[活动日志] --> F[非活动日志]
        F --> G[归档日志]
        G --> H[删除日志]
    end
    
    E --> E1[当前正在使用]
    F --> F1[已切换但未归档]
    G --> G1[已归档保存]
    H --> H1[已删除释放空间]
    
    style E fill:#4caf50
    style F fill:#ff9800
    style G fill:#2196f3
    style H fill:#9e9e9e
```

## 9.4 数据转储

### 9.4.1 转储的分类

```mermaid
graph TD
    A[数据转储分类] --> B[按转储时机]
    A --> C[按转储内容]
    
    B --> B1[静态转储<br/>Static Dump]
    B --> B2[动态转储<br/>Dynamic Dump]
    
    C --> C1[海量转储<br/>Full Dump]
    C --> C2[增量转储<br/>Incremental Dump]
    
    B1 --> B11[在没有事务运行时进行<br/>转储期间不允许对数据库进行任何存取、修改活动<br/>得到的副本是数据库的一致性副本]
    
    B2 --> B21[转储期间允许对数据库进行存取或修改<br/>转储和用户事务可以并发进行<br/>不能保证副本中数据的一致性]
    
    C1 --> C11[转储整个数据库<br/>转储开销大<br/>恢复时间长]
    
    C2 --> C21[只转储上次转储后<br/>更新过的数据<br/>转储开销小<br/>恢复时需要多个转储副本]
    
    style B1 fill:#ffcdd2
    style B2 fill:#e8f5e8
    style C1 fill:#bbdefb
    style C2 fill:#fff3e0
```

### 9.4.2 转储策略的选择

```mermaid
graph TD
    A[转储策略选择] --> B[数据库大小]
    A --> C[更新频率]
    A --> D[可用时间窗口]
    A --> E[恢复时间要求]
    
    B --> B1[小型数据库<br/>选择海量转储]
    B --> B2[大型数据库<br/>选择增量转储]
    
    C --> C1[更新频繁<br/>选择动态转储]
    C --> C2[更新较少<br/>选择静态转储]
    
    D --> D1[有维护时间窗口<br/>选择静态转储]
    D --> D2[7×24小时运行<br/>选择动态转储]
    
    E --> E1[要求快速恢复<br/>选择海量转储]
    E --> E2[可接受较长恢复时间<br/>选择增量转储]
    
    subgraph "推荐组合"
        F[小型数据库<br/>静态海量转储]
        G[中型数据库<br/>动态海量转储+增量转储]
        H[大型数据库<br/>动态增量转储+定期海量转储]
    end
    
    style F fill:#4caf50
    style G fill:#ff9800
    style H fill:#2196f3
```

## 9.5 检查点技术

### 9.5.1 检查点的概念

```mermaid
graph TD
    A[检查点技术] --> B[检查点的作用]
    A --> C[检查点的内容]
    A --> D[检查点的设置]
    
    B --> B1[缩短系统恢复时间<br/>减少需要重做的事务<br/>确定恢复的起始点]
    
    C --> C1[建立检查点时刻<br/>所有正在执行的事务清单]
    C --> C2[这些事务最近一个<br/>日志记录的地址]
    
    D --> D1[定时设置<br/>按事务数量设置<br/>按日志量设置]
    
    subgraph "检查点记录格式"
        E[CHECKPOINT]
        E --> F[T1: LSN1]
        E --> G[T2: LSN2]
        E --> H[T3: LSN3]
    end
    
    style A fill:#e3f2fd
```

### 9.5.2 检查点的建立过程

```mermaid
sequenceDiagram
    participant System as 系统
    participant Log as 日志文件
    participant Buffer as 缓冲区
    participant Disk as 磁盘
    
    System->>Log: 1. 将当前日志缓冲区内容写入日志文件
    System->>Buffer: 2. 在日志文件中写入一个检查点记录
    System->>Disk: 3. 将当前数据缓冲区的内容写入数据库
    System->>Log: 4. 把检查点记录在日志文件中的地址写入重新开始文件
    
    Note over System: 检查点建立完成
```

### 9.5.3 利用检查点进行恢复

```mermaid
flowchart TD
    A[系统故障恢复] --> B[从重新开始文件中<br/>找到最新检查点]
    B --> C[从检查点开始<br/>正向扫描日志文件]
    C --> D[重做REDO集合中<br/>已提交事务的操作]
    D --> E[撤销UNDO集合中<br/>未提交事务的操作]
    E --> F[恢复完成]
    
    subgraph "事务分类"
        G[REDO集合<br/>检查点之前开始<br/>故障前已提交]
        H[UNDO集合<br/>检查点之前开始<br/>故障时未提交]
        I[REDO集合<br/>检查点之后开始<br/>故障前已提交]
    end
    
    C --> G
    C --> H
    C --> I
    
    style D fill:#4caf50
    style E fill:#ffcdd2
```

## 9.6 恢复策略

### 9.6.1 事务故障的恢复

```mermaid
flowchart TD
    A[事务故障恢复] --> B[反向扫描日志文件]
    B --> C[查找该事务的更新操作]
    C --> D[对该事务的更新操作<br/>执行逆操作]
    D --> E[继续反向扫描日志文件]
    E --> F{是否到达该事务的<br/>BEGIN记录?}
    F -->|否| C
    F -->|是| G[事务撤销完成]
    
    subgraph "逆操作示例"
        H[INSERT → DELETE]
        I[DELETE → INSERT]
        J[UPDATE → 用Before Image恢复]
    end
    
    style G fill:#4caf50
```

### 9.6.2 系统故障的恢复

```mermaid
graph TD
    A[系统故障恢复] --> B[重新启动系统]
    B --> C[扫描日志文件]
    C --> D[确定恢复范围]
    D --> E[重做已提交事务]
    D --> F[撤销未提交事务]
    E --> G[恢复完成]
    F --> G
    
    subgraph "恢复步骤详解"
        H[1. 正向扫描日志<br/>找出故障时已提交的事务]
        I[2. 反向扫描日志<br/>撤销未提交事务的操作]
        J[3. 正向扫描日志<br/>重做已提交事务的操作]
    end
    
    C --> H
    H --> I
    I --> J
    J --> G
    
    style G fill:#4caf50
```

### 9.6.3 介质故障的恢复

```mermaid
flowchart TD
    A[介质故障恢复] --> B[装入最新的数据库副本]
    B --> C[装入相应的日志文件副本]
    C --> D[重做自转储以来<br/>所有已提交事务]
    D --> E[恢复至故障前状态]
    
    subgraph "恢复时间线"
        F[数据库转储时间] --> G[故障发生时间]
        F --> F1[转储副本]
        G --> G1[需要重做的事务]
    end
    
    B --> F1
    D --> G1
    
    subgraph "恢复要求"
        H[必须有数据库副本]
        I[必须有日志文件副本]
        J[日志文件副本要完整]
    end
    
    style E fill:#4caf50
    style H fill:#ffcdd2
    style I fill:#ffcdd2
    style J fill:#ffcdd2
```

## 9.7 镜像技术

### 9.7.1 镜像的概念

```mermaid
graph TD
    A[镜像技术] --> B[定义]
    A --> C[类型]
    A --> D[优点]
    A --> E[缺点]
    
    B --> B1[根据数据的重要性<br/>将关键数据在多个磁盘上<br/>保存多个完全相同的副本]
    
    C --> C1[实时镜像<br/>同步更新]
    C --> C2[异步镜像<br/>延迟更新]
    
    D --> D1[提高系统可靠性<br/>快速故障恢复<br/>提高查询性能]
    
    E --> E1[增加存储成本<br/>降低更新性能<br/>增加系统复杂性]
    
    subgraph "镜像配置"
        F[主数据库] --> G[镜像1]
        F --> H[镜像2]
        F --> I[镜像3]
    end
    
    style C1 fill:#4caf50
    style C2 fill:#ff9800
```

### 9.7.2 镜像的实现方式

```mermaid
graph TD
    A[镜像实现方式] --> B[硬件级镜像]
    A --> C[操作系统级镜像]
    A --> D[数据库级镜像]
    A --> E[应用级镜像]
    
    B --> B1[RAID技术<br/>磁盘阵列控制器<br/>透明镜像]
    
    C --> C1[操作系统提供<br/>文件系统级镜像<br/>卷镜像]
    
    D --> D1[数据库系统提供<br/>表空间镜像<br/>日志文件镜像]
    
    E --> E1[应用程序控制<br/>数据同步<br/>业务逻辑镜像]
    
    subgraph "性能对比"
        F[硬件级: 性能最好]
        G[操作系统级: 性能较好]
        H[数据库级: 性能一般]
        I[应用级: 性能较差]
    end
    
    B --> F
    C --> G
    D --> H
    E --> I
    
    style B fill:#4caf50
```

## 9.8 恢复技术的综合应用

### 9.8.1 恢复策略的组合

```mermaid
graph TD
    A[恢复策略组合] --> B[转储+日志]
    A --> C[检查点+日志]
    A --> D[镜像+日志]
    A --> E[综合策略]
    
    B --> B1[定期转储数据库<br/>记录所有更新操作<br/>故障时用转储+日志恢复]
    
    C --> C1[设置检查点<br/>记录检查点后的操作<br/>故障时从检查点开始恢复]
    
    D --> D1[实时镜像关键数据<br/>记录操作日志<br/>主系统故障时切换到镜像]
    
    E --> E1[转储+日志+检查点+镜像<br/>多层次保护<br/>不同故障采用不同策略]
    
    style E fill:#4caf50
```

### 9.8.2 恢复方案设计

```mermaid
flowchart TD
    A[恢复方案设计] --> B[分析业务需求]
    B --> C[评估故障风险]
    C --> D[选择恢复技术]
    D --> E[制定恢复策略]
    E --> F[实施和测试]
    
    B --> B1[RTO要求<br/>RPO要求<br/>业务重要性]
    
    C --> C1[硬件故障概率<br/>软件故障概率<br/>人为错误概率<br/>自然灾害风险]
    
    D --> D1[转储策略<br/>日志策略<br/>检查点策略<br/>镜像策略]
    
    E --> E1[恢复流程<br/>责任分工<br/>时间安排<br/>资源配置]
    
    F --> F1[定期演练<br/>方案优化<br/>文档更新]
    
    style F fill:#4caf50
```

## 9.9 学习检查点

### 9.9.1 重点概念总结

```mermaid
mindmap
  root((数据库恢复))
    事务概念
      ACID特性
        原子性
        一致性
        隔离性
        持久性
      事务状态
        活动状态
        部分提交
        提交状态
        失败状态
        中止状态
    故障类型
      事务内部故障
      系统故障
      介质故障
      计算机病毒
    恢复技术
      数据转储
        静态转储
        动态转储
        海量转储
        增量转储
      日志文件
        WAL协议
        日志记录
        日志管理
      检查点技术
        检查点设置
        恢复优化
      镜像技术
        实时镜像
        异步镜像
```

### 9.9.2 练习题

1. **事务和ACID特性**
   - 解释事务的ACID特性
   - 分析事务状态转换过程
   - 设计事务处理示例

2. **恢复技术应用**
   - 比较不同转储策略的优缺点
   - 设计日志记录格式
   - 分析检查点技术的作用

3. **恢复策略设计**
   - 针对不同故障类型设计恢复方案
   - 计算恢复时间和存储开销
   - 优化恢复性能

### 9.9.3 思考题

1. 为什么需要WAL协议？它如何保证数据的一致性？
2. 检查点技术如何减少恢复时间？
3. 在什么情况下应该选择镜像技术？
4. 如何平衡恢复能力和系统性能？

---

**本章小结**：数据库恢复技术是保证数据库系统可靠性的重要手段。通过事务管理、日志记录、数据转储、检查点和镜像等技术的综合应用，可以有效应对各种故障情况，确保数据的安全性和一致性。在实际应用中，需要根据业务需求和系统特点，选择合适的恢复策略组合。

---
**上一章：** [第8章 关系查询处理和查询优化](第8章_关系查询处理和查询优化.md)  
**下一章：** [第10章 并发控制](第10章_并发控制.md)